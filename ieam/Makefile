export ARCH ?= $(shell hzn architecture)

# Import variables from hzn.json (file is generated by last target in this file)
-include .hzn.json.tmp.mk

pull:
	docker login -u $(CONTAINER_REGISTRY_USERNAME) -p $(CONTAINER_REGISTRY_PASSWORD) $(CONTAINER_REGISTRY)
	docker pull $(CONTAINER_REGISTRY)/$(NAMESPACE)/$(IMAGE_NAME):$(SERVICE_VERSION)

push:	
	docker login -u $(CONTAINER_REGISTRY_USERNAME) -p $(CONTAINER_REGISTRY_PASSWORD) $(CONTAINER_REGISTRY)
	docker tag $(IMAGE_NAME):$(SERVICE_VERSION) $(CONTAINER_REGISTRY)/$(NAMESPACE)/$(IMAGE_NAME):$(SERVICE_VERSION)
	docker push $(CONTAINER_REGISTRY)/$(NAMESPACE)/$(IMAGE_NAME):$(SERVICE_VERSION)

publish-service:
	hzn exchange service publish -r "$(CONTAINER_REGISTRY):$(CONTAINER_REGISTRY_USERNAME):$(CONTAINER_REGISTRY_PASSWORD)" -f horizon/service.definition.json --pull-image


add-policy:
	hzn exchange business addpolicy -f horizon/deployment-policy.json deploy_$(IMAGE_NAME)_$(SERVICE_VERSION)_$(ARCH)
	hzn exchange service addpolicy -f horizon/service-policy.json $(SERVICE_NAME)_$(SERVICE_VERSION)_$(ARCH)

key:
	hzn key create IBM ieam@ibm.com

# ----------------------------------------------------------------------------
# This imports the variables from hzn.json
.hzn.json.tmp.mk: horizon/hzn.json
	@ hzn util configconv -f $< > $@